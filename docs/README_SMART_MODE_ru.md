# HLS Smart режим и его состовляющие

Эта иструкция нужна тем, кто хочет понять: “Что это за десятки странных названий настроек, и какие из них трогать?”

## 1. Как включить всё «умное»
Есть настройка: **HLS playlist reload time**.  
Если выбрать значение **smart**, включается расширенный «умный» режим.  
Он сам решает: когда снова спросить плейлист, как быстро догонять прямой эфир, что делать при паузах, как реагировать на скачки, что делать с VOD (записью), когда остановиться, и как временно «прокручивать» старый сегмент, чтобы не застыл экран.

Если выбрать:
- segment — просто ждём столько же, сколько длился последний сегмент (тег #EXTINF).
- targetduration — ждём «целевое» время указанное для всего плейлиста (не для отдельных сегментов, тег #EXT-X-TARGETDURATION).
- smart - за основу берется длина сегмента, работают все описанные ниже «умности».

Если в плейлисте не указано ни длительности сегмента, ни targetduration - берется статичное время 6 сек.

## 2. Что входит в Smart
| Часть | Коротко | Работает вне smart? |
|-------|---------|---------------------|
| Step3 (три ступени ожидания) | Быстро проверяем, если что-то меняется, и реже — когда тишина | Нет |
| «Отставание / запас» (drift) | Если сильно отстали — ускоряем проверки, если запас большой — расслабляемся | Нет |
| Batch (пачка сегментов) | Если пришло сразу много сегментов — подстраиваем темп | Нет |
| Авто VOD + ускорение после разрывов | В записи другой ритм + быстрые проверки после разрыва | Нет |
| Replay (повтор) | Крутим последний кусок, чтобы картинка не «замёрзла» | Почти нет |
| Случайное смещение (jitter) | Чтобы запросы не шли строго в такт | Нет |
| Gap (долгая тишина ⇒ стоп) | Останавливаемся, если новых сегментов нет слишком долго | Да (простая версия) |
| Gap защита «не останавливайся рано» | Не останавливаемся зря, если ещё есть запас вперёд | Нет |

В других режимах реально остаётся только простая остановка по «тихому» таймеру (Gap). Остальное – не работает.

## 3. Как читать описания
Для каждой настройки ниже:
- Что делает.
- Если увеличить.
- Если уменьшить.
- Когда трогать.
- Рекомендованный диапазон.
- Работает ли только в smart.

Не пугайтесь слов «сегмент»: это один маленький файл видео.  
Если сказано «часть длительности сегмента 0.5» и сам сегмент 6 секунд — значит фактически около 3 секунд ожидания.
Описанные ниже переменные находятся в файле «[tvlink/libs/streamlink/stream/hls/hls.py](https://github.com/AlexELEC/TVLINK-x86_64-Ubuntu/blob/master/libs/streamlink/stream/hls/hls.py#L455-L504)».

---

### 3.1. Основные таймеры Smart

#### reload_early_offset_s (по умолчанию 0.02)  [только smart]
Что: Насколько раньше обычного можно спросить плейлист, когда ожидание “нового” сегмента ещё не дошло до конца.  
Увеличить: Будем чаще «забегать вперёд», больше запросов.  
Уменьшить (0): Можем чуть позже замечать новый сегмент.  
Когда трогать: Редко.  
Рекомендация: 0.0–0.25 (обычно 0.01–0.05).  
Совет: Поток стабилен? Поставьте 0.0.

#### reload_jitter_ms (30)  [только smart]
Что: Лёгкое случайное «дрожание» времени запроса (миллисекунды), чтобы не бить по серверу строго равномерно.  
Увеличить: Чуть более «живой» ритм.  
Уменьшить (0): Абсолютно одинаковые интервалы.  
Когда трогать: Почти никогда.  
Рекомендация: 10–80.  

---

### 3.2. Step3 — три ступени ожидания (всё только smart)

(Ниже «первая / вторая / третья и дальше без изменений» — это сколько раз подряд мы увидели, что новых сегментов не добавилось.)

#### step3_changed_ratio (1.00)
Что: Максимально долго (по отношению к длительности сегмента) мы ждём после того, как появился новый.  
Увеличить: Реже спрашиваем, можем чуточку позже увидеть следующий.  
Уменьшить: Чаще спрашиваем, быстрее реагируем.  
Рекомендация: 0.8–1.2.  
Трогать: Только если нужно «ещё быстрее».

#### step3_u1_ratio (0.50)
Что: Сколько ждать (часть длительности сегмента) после первой «тишины».  
Больше: Экономим запросы.  
Меньше: Быстрее ловим возобновление.  
Рекомендация: 0.4–0.7.

#### step3_u2_ratio (0.50)
То же, но для второй подряд «тишины».  
Рекомендация: 0.4–0.7.

#### step3_min_ratio (0.25)
Что: Минимальная доля ожидания на третьем и всех следующих «нет новинок».  
Больше: Ленивая проверка.  
Меньше: Очень частые повторные запросы.  
Рекомендация: 0.20–0.35.

#### step3_cv_window (8)
Что: Сколько последних сегментов смотрим, чтобы понять «стабильно или скачет» длительность сегментов.  
Больше: Плавнее, но медленнее перестраивается.  
Меньше: Реагирует быстрее, но нервно.  
Рекомендация: 5–12.  
Трогать: Редко.

#### step3_cv_high (0.25)
Что: Верхний порог «сильно скачет длительность». Тогда мы НЕ слишком уменьшаем ожидание.  
Увеличить: Реже считаем поток “хаотичным”.  
Уменьшить: Чаще «боимся», ждём осторожнее.  
Рекомендация: 0.20–0.35.

#### step3_cv_low (0.08)
Что: Нижний порог «очень стабильно». Тогда можно чуть удлинить паузу (экономить запросы).  
Увеличить: Реже признаём «стабильно».  
Уменьшить: Чаще.  
Рекомендация: 0.05–0.12.

#### step3_cv_floor_ratio (0.40)
Что: «Пол» — ниже этой доли не уменьшаем ожидание, если поток «скачет».  
Увеличить: Более осторожно (не слишком ускоряемся).  
Уменьшить: Позволяем сильное ускорение.  
Рекомендация: 0.35–0.5.

---

### 3.3. Отставание и запас (быстро догнать / не перегонять)  [всё только smart]

(Представьте: мы проиграли N секунд видео. Сколько реально времени прошло? Если прошло больше — значит «отстаём». Если меньше — у нас запас.)

#### step3_drift_target_factor (1.1)
Что: Какой запас секунд «вперёд» считаем нормальным.  
Увеличить: Больше запас → безопаснее, но можем чуть позже получить новый кусок.  
Уменьшить: Меньше запас → быстрее догоняем, но меньше страховки.  
Рекомендация: 1.05–1.3.  
Совет: Не менять без повода.

#### step3_drift_aggr_reduce (0.05)
Что: Насколько сильнее сокращаем ожидание, если отставание уже большое.  
Увеличить: Агрессивнее догоняем.  
Уменьшить: Спокойнее.  
Рекомендация: 0.03–0.08.

#### step3_drift_ahead_increase (0.02)
Что: Насколько слегка растягивать ожидание, если запас уже хороший.  
Увеличить: Можем чуть запаздывать позже.  
Уменьшить: Меньше расслабляемся.  
Рекомендация: 0.01–0.04.

#### step3_drift_lvl1 / step3_drift_lvl2 / step3_drift_lvl3 (0.60 / 1.00 / 1.40)
Что: Три ступени «насколько сильно мы отстаём» (условно: небольшое / заметное / большое).  
Уменьшить значения: Ускорение включается раньше.  
Обычно не менять — важны расстояния между ступенями.

#### step3_drift_reduce1 (0.10), step3_drift_reduce2 (0.20)
Что: Насколько сокращаем время ожидания на ступенях 1 и 2.  
Увеличить: Резче догоняем.  
Уменьшить: Мягче.  
Рекомендация: 0.08–0.15 и 0.15–0.30.

#### step3_drift_min_ratio (0.35)
Что: Насколько низко вообще позволяем опускаться ожиданию в «катастрофическом» отставании.  
Увеличить: Менее агрессивно.  
Уменьшить: Частые запросы.  
Рекомендация: 0.30–0.45.

#### step3_drift_projection_headroom_factor (0.30)
Что: «Запас», который не срезаем когда прикидываем наперёд «можно ли ещё ускориться».  
Увеличить: Более осторожно.  
Уменьшить: Сильнее режем.  
Рекомендация: 0.2–0.4.

#### step3_drift_projection_min_gain_ratio (0.05)
Что: Минимальная ощутимая выгода (сколько секунд примерно экономим), чтобы вообще имело смысл сокращать ожидание «по прогнозу».  
Увеличить: Реже используем прогноз.  
Уменьшить: Чаще.  
Рекомендация: 0.03–0.08.

---

### 3.4. Пакетная публикация (batch)  [только smart]

#### step3_batch_threshold (3)
Что: Сколько новых сегментов подряд считаем «пачкой».  
Увеличить: Реже включается спец-режим.  
Уменьшить: Чаще.  
Рекомендация: 2–4.

#### step3_batch_follow_ratio (0.60)
Что: Насколько быстро проверяем после пачки (чем меньше — тем быстрее).  
Увеличить: Медленнее реагируем на следующую волну.  
Уменьшить: Быстрее, но больше запросов.  
Рекомендация: 0.5–0.75.

#### step3_batch_follow_cap_s (3.5)
Что: «Потолок» секунд ожидания после пачки.  
Увеличить: Можем быть медлительнее на длинных кусках.  
Уменьшить: Больше запросов при длинных кусках.  
Рекомендация: 2.0–5.0.

---

### 3.5. VOD (запись) — умная логика  [только smart]

#### vod_auto_discont_boost_reloads (2)
Что: Сколько быстрых проверок сделать после резкого разрыва (discontinuity), чтобы быстрее «ожить».  
Увеличить: Быстрее восстанавливаемся, больше запросов.  
Рекомендация: 2–4.

#### vod_reload_publish_slack_s (0.30)
Что: Запас секунд спокойного ожидания, если новых сегментов нет.  
Увеличить: Менее нервно.  
Уменьшить: Чаще проверяем.  
Рекомендация: 0.2–0.6.

#### vod_reload_idle_min (1.00)
Что: Минимальная пауза между проверками в спокойном VOD.  
Увеличить: Меньше запросов.  
Уменьшить: Больше запросов.  
Рекомендация: 0.8–2.0.

---

### 3.6. Gap — остановка при «тишине»

Работает в любом режиме, но «умные» защиты (ниже) полноценно — только в smart.

#### gap_stop_min_absolute_s (10.0)
Что: Минимум секунд без новых сегментов перед остановкой.  
Увеличить: Дольше терпим.  
Уменьшить: Риск остановиться слишком рано.  
Рекомендация: 8–20.

#### gap_stop_min_growth_samples (3)
Что: Сколько наблюдений длительности сегментов нужно, чтобы оценка была увереннее.  
Увеличить: Надёжнее, но позже «понимаем».  
Уменьшить: Быстрее реагируем, но грубее.  
Рекомендация: 3–5.

#### gap_small_segment_floor_s (2.0)
Что: Если сегменты очень короткие — не считаем меньше этого при вычислениях.  
Увеличить: Менее чувствительно к сверхкоротким.  
Уменьшить: Более чувствительно.  
Рекомендация: 1.5–3.0.

#### gap_drift_guard_trigger (-2.0)  [только smart]
Что: Защита «не останавливайся рано». Если наш текущий запас вперёд ещё хотя бы около 2 секунд (плюс-минус), мы НЕ считаем это настоящей «мертвой» остановкой.  
Увеличить (например -1): Защита слабее — остановимся раньше.  
Уменьшить (например -3): Терпимливее.  
Рекомендация: -3.0 … -1.0.

---

### 3.7. Повтор сегмента (Replay)  [почти только smart]

#### event_replay_buffer_min_s (1.0)
Что: Если запас видео впереди меньше этого — разрешаем временно повторить последний сегмент, чтобы не замерла картинка.  
Увеличить: Повтор сработает раньше.  
Уменьшить: Позже.  
Рекомендация: 0.8–1.5.

#### event_segment_arrival_risk_threshold_s (0.0)
Что: Порог «скоро может застыть». 0 = автоматически берём половину длины сегмента.  
Увеличить: Предупреждение позже.  
Уменьшить (>0): Раньше.  
Рекомендация: 0 или 0.5–2.0.

#### replay_cooldown_limit (3)
Что: Сколько раз подряд можно повторять без новых настоящих сегментов.  
Увеличить: Дольше имитация движения.  
Уменьшить: Быстрее сдаёмся.  
Рекомендация: 2–4.

---

## 4. Быстрые подсказки (что изменить, если)

| Хочу | Что делать |
|------|------------|
| Максимально быстро видеть новое | Понизить step3_changed_ratio до ~0.9, u1/u2 до ~0.45 |
| Поменьше запросов | Поднять u1/u2 до ~0.6–0.65, увеличить changed_ratio до ~1.05 |
| Успокоить дёрганый поток | Повысить step3_cv_floor_ratio до ~0.45 |
| Быстрее догонять эфир | Повысить drift_reduce1/2 (0.12 / 0.25), понизить drift_min_ratio до ~0.30 |
| Реже ложные остановки | gap_stop_min_absolute_s → 15; gap_drift_guard_trigger → -2.5 |
| Мягче с повтором | replay_cooldown_limit → 2; event_replay_buffer_min_s → 1.2 |

(Если не уверены — ничего не меняйте.)

---

## 5. Частые вопросы

**Нужно ли знать HLS, чтобы это настроить?**  
Нет. Просто понимайте идею: мы периодически обновляем список сегментов.

**Можно всё оставить как есть?**  
Да. Это безопасный универсальный набор.

**Почему так много настроек?**  
Чтобы можно было балансировать между “быстро показать” и “не засыпать сервер”.

**Если что-то сломал?**  
Верните значения по умолчанию (из этого файла: «[tvlink/libs/streamlink/stream/hls/hls.py](https://github.com/AlexELEC/TVLINK-x86_64-Ubuntu/blob/master/libs/streamlink/stream/hls/hls.py#L455-L504)»).

**Replay — это не «обман»?**  
Нет, мы просто повторяем уже скачанный сегмент, чтобы у вас не застыл экран.

---

## 6. Мини-наборы (готовые комбинации)

Стабильный поток (хочу потише):
```
step3_u1_ratio = 0.55
step3_u2_ratio = 0.55
reload_early_offset_s = 0.0
```

Отстаёт / хочу догонять:
```
step3_drift_reduce1 = 0.12
step3_drift_reduce2 = 0.25
step3_drift_min_ratio = 0.30
```

Ложные «стопы» слишком рано:
```
gap_stop_min_absolute_s = 15
gap_drift_guard_trigger = -2.5
```

---

## 7. Итог
1. Выберите режим smart — получите все возможности.  
2. Не уверены — оставьте как есть.  
3. Меняйте только если понимаете цель.  

Приятного просмотра!