# Режим HLS Smart та його складові

Ця інструкція для тих, хто хоче зрозуміти: “Що це за десятки дивних назв налаштувань і які з них варто змінювати?”

## 1. Як увімкнути все «розумне»
Є налаштування: **HLS playlist reload time**.  
Якщо вибрати **smart**, вмикається розширений «розумний» режим.  
Він сам вирішує: коли знову запитати плейлист, як швидко наздоганяти прямий ефір, що робити під час пауз, як реагувати на стрибки, що робити з VOD (записом), коли зупинятися та як тимчасово «прокручувати» останній сегмент, щоб зображення не зависало.

Якщо вибрати:
- segment — просто чекаємо стільки, скільки тривав останній сегмент (тег #EXTINF).
- targetduration — чекаємо «цільовий» час, вказаний для всього плейлиста (не окремих сегментів, тег #EXT-X-TARGETDURATION).
- smart — за основу береться довжина сегмента, працюють усі описані нижче «розумні» функції.

Якщо у плейлисті не вказано ні тривалість сегмента, ні targetduration — береться статичний час 6 с.

## 2. Що входить до Smart
| Частина | Коротко | Працює поза smart? |
|---------|---------|--------------------|
| Step3 (три щаблі очікування) | Часті перевірки при змінах, рідші — коли тиша | Ні |
| «Відставання / запас» (drift) | Якщо сильно відстали — пришвидшуємо перевірки, якщо запас великий — розслабляємось | Ні |
| Batch (пакет сегментів) | Якщо прийшло багато сегментів одразу — підлаштовуємо темп | Ні |
| Авто VOD + прискорення після розривів | В записі інший ритм + швидкі перевірки після розриву | Ні |
| Replay (повтор) | Крутимо останній шматок, щоб картинка не «завмерла» | Майже ні |
| Випадковий зсув (jitter) | Щоб запити не йшли строго в такт | Ні |
| Gap (довга тиша ⇒ стоп) | Зупиняємось, якщо нових сегментів немає занадто довго | Так (спрощена версія) |
| Gap захист «не зупиняйся рано» | Не зупиняємося даремно, якщо ще є запас уперед | Ні |

В інших режимах реально лишається тільки просте зупинення по «тихому» таймеру (Gap). Решта – не працює.

## 3. Як читати описи
Для кожного параметра нижче:
- Що робить.
- Якщо збільшити.
- Якщо зменшити.
- Коли змінювати.
- Рекомендований діапазон.
- Чи працює тільки в smart.

Не лякайтесь слова «сегмент»: це один маленький відеофайл.  
Якщо сказано «частка тривалості сегмента 0.5» і сам сегмент 6 секунд — значить приблизно 3 секунди очікування.
Зазначені нижче змінні знаходяться у файлі «tvlink/libs/streamlink/stream/hls/hls.py».

---

### 3.1. Основні Smart-таймери

#### reload_early_offset_s (типово 0.02)  [тільки smart]
Що: Наскільки раніше звичайного можна запросити плейлист, коли час очікування «нового» сегмента ще не вичерпано.  
Збільшити: Частіше «забігаємо вперед», більше запитів.  
Зменшити (0): Можемо трохи пізніше помітити новий сегмент.  
Коли: Рідко.  
Рекомендація: 0.0–0.25 (зазвичай 0.01–0.05).  
Порада: Потік стабільний? Поставте 0.0.

#### reload_jitter_ms (30)  [тільки smart]
Що: Легке випадкове «тремтіння» часу запиту (мілісекунди), щоб не бити по серверу рівно.  
Збільшити: Трішки живіший ритм.  
Зменшити (0): Абсолютно однакові інтервали.  
Коли: Майже ніколи.  
Рекомендація: 10–80.  

---

### 3.2. Step3 — три щаблі очікування (все тільки smart)

(Нижче «перша / друга / третя і далі без змін» — це скільки разів поспіль ми побачили, що нові сегменти не додалися.)

#### step3_changed_ratio (1.00)
Що: Максимально довго (відносно тривалості сегмента) чекаємо після появи нового.  
Збільшити: Рідше запитуємо, можемо трохи пізніше побачити наступний.  
Зменшити: Частіше запитуємо, швидше реагуємо.  
Рекомендація: 0.8–1.2.  
Чіпати: Лише якщо треба «ще швидше».

#### step3_u1_ratio (0.50)
Що: Скільки чекати (частка тривалості сегмента) після першої «тиші».  
Більше: Економимо запити.  
Менше: Швидше ловимо відновлення.  
Рекомендація: 0.4–0.7.

#### step3_u2_ratio (0.50)
Те саме, але для другої поспіль «тиші».  
Рекомендація: 0.4–0.7.

#### step3_min_ratio (0.25)
Що: Мінімальна частка очікування на третій і всіх наступних «немає новинок».  
Більше: Лінива перевірка.  
Менше: Дуже часті запити.  
Рекомендація: 0.20–0.35.

#### step3_cv_window (8)
Що: Скільки останніх сегментів дивимось, щоб зрозуміти «стабільно чи скаче» тривалість.  
Більше: Плавніше, але повільніше перебудовується.  
Менше: Реагує швидше, але «нервово».  
Рекомендація: 5–12.  
Коли: Рідко.

#### step3_cv_high (0.25)
Що: Верхній поріг «сильно скаче тривалість». Тоді ми НЕ надто зменшуємо очікування.  
Збільшити: Рідше вважаємо потік хаотичним.  
Зменшити: Частіше «боїмося».  
Рекомендація: 0.20–0.35.

#### step3_cv_low (0.08)
Що: Нижній поріг «дуже стабільно». Тоді можна трохи подовжити паузу (економити запити).  
Збільшити: Рідше визнаємо «стабільно».  
Зменшити: Частіше.  
Рекомендація: 0.05–0.12.

#### step3_cv_floor_ratio (0.40)
Що: «Підлога» — нижче цієї частки не зменшуємо очікування, якщо потік «скаче».  
Збільшити: Обережніше (не сильно пришвидшуємось).  
Зменшити: Дозволяємо сильне прискорення.  
Рекомендація: 0.35–0.5.

---

### 3.3. Відставання і запас (швидко наздогнати / не перегнати)  [все тільки smart]

(Уявіть: ми відтворили N секунд відео. Скільки реального часу минуло? Якщо більше — ми «відстаємо». Якщо менше — маємо запас.)

#### step3_drift_target_factor (1.1)
Що: Який запас уперед (фактор) вважаємо нормальним.  
Збільшити: Більший запас → безпечніше, але можемо трохи пізніше отримати новий шматок.  
Зменшити: Менший запас → швидше наздоганяємо, але менше страховки.  
Рекомендація: 1.05–1.3.  
Порада: Не змінюйте без причини.

#### step3_drift_aggr_reduce (0.05)
Що: Наскільки сильніше скорочуємо очікування, якщо відставання вже велике.  
Збільшити: Агресивніше наздоганяємо.  
Зменшити: Спокійніше.  
Рекомендація: 0.03–0.08.

#### step3_drift_ahead_increase (0.02)
Що: Наскільки трохи збільшувати очікування, якщо запас хороший.  
Збільшити: Можемо трохи відстати пізніше.  
Зменшити: Менше «розслабляємось».  
Рекомендація: 0.01–0.04.

#### step3_drift_lvl1 / step3_drift_lvl2 / step3_drift_lvl3 (0.60 / 1.00 / 1.40)
Що: Три ступені «наскільки відстаємо» (невелике / помітне / велике).  
Зменшити значення: Прискорення вмикається раніше.  
Зазвичай не змінювати — важливі відстані між рівнями.

#### step3_drift_reduce1 (0.10), step3_drift_reduce2 (0.20)
Що: Наскільки скорочуємо час очікування на щаблях 1 і 2.  
Збільшити: Різкіше наздоганяємо.  
Зменшити: М'якше.  
Рекомендація: 0.08–0.15 і 0.15–0.30.

#### step3_drift_min_ratio (0.35)
Що: Наскільки низько можемо опускати очікування у «катастрофічному» відставанні.  
Збільшити: Менш агресивно.  
Зменшити: Часті запити.  
Рекомендація: 0.30–0.45.

#### step3_drift_projection_headroom_factor (0.30)
Що: «Запас», який не зрізаємо, коли прогнозуємо «чи можна ще прискоритись».  
Збільшити: Більш обережно.  
Зменшити: Сильніше ріжемо.  
Рекомендація: 0.2–0.4.

#### step3_drift_projection_min_gain_ratio (0.05)
Що: Мінімальна відчутна вигода (скільки секунд економимо), щоб було сенс скорочувати очікування «за прогнозом».  
Збільшити: Рідше використовуємо прогноз.  
Зменшити: Частіше.  
Рекомендація: 0.03–0.08.

---

### 3.4. Пакетна публікація (batch)  [тільки smart]

#### step3_batch_threshold (3)
Що: Скільки нових сегментів поспіль вважаємо «пакетом».  
Збільшити: Рідше вмикається спец-режим.  
Зменшити: Частіше.  
Рекомендація: 2–4.

#### step3_batch_follow_ratio (0.60)
Що: Наскільки швидко перевіряємо після пакета (менше — швидше).  
Збільшити: Повільніше реагуємо на наступну хвилю.  
Зменшити: Швидше, але більше запитів.  
Рекомендація: 0.5–0.75.

#### step3_batch_follow_cap_s (3.5)
Що: «Стеля» секунд очікування після пакета.  
Збільшити: Можемо бути повільнішими на довгих шматках.  
Зменшити: Більше запитів при довгих шматках.  
Рекомендація: 2.0–5.0.

---

### 3.5. VOD (запис) — розумна логіка  [тільки smart]

#### vod_auto_discont_boost_reloads (2)
Що: Скільки швидких перевірок зробити після різкого розриву (discontinuity), щоб швидше «ожити».  
Збільшити: Швидше відновлюємось, більше запитів.  
Рекомендація: 2–4.

#### vod_reload_publish_slack_s (0.30)
Що: Запас секунд спокійного очікування, якщо нових сегментів немає.  
Збільшити: Менш нервово.  
Зменшити: Частіше перевіряємо.  
Рекомендація: 0.2–0.6.

#### vod_reload_idle_min (1.00)
Що: Мінімальна пауза між перевірками у спокійному VOD.  
Збільшити: Менше запитів.  
Зменшити: Більше запитів.  
Рекомендація: 0.8–2.0.

---

### 3.6. Gap — зупинка при «тиші»

Працює в будь-якому режимі, але «розумні» захисти (нижче) повністю — лише в smart.

#### gap_stop_min_absolute_s (10.0)
Що: Мінімум секунд без нових сегментів перед зупинкою.  
Збільшити: Довше терпимо.  
Зменшити: Ризик зупинитися зарано.  
Рекомендація: 8–20.

#### gap_stop_min_growth_samples (3)
Що: Скільки спостережень тривалості сегментів потрібно для впевненішої оцінки.  
Збільшити: Надійніше, але пізніше «розуміємо».  
Зменшити: Швидше реагуємо, але грубіше.  
Рекомендація: 3–5.

#### gap_small_segment_floor_s (2.0)
Що: Якщо сегменти дуже короткі — не враховуємо менше цього при обчисленнях.  
Збільшити: Менш чутливо до надкоротких.  
Зменшити: Більш чутливо.  
Рекомендація: 1.5–3.0.

#### gap_drift_guard_trigger (-2.0)  [тільки smart]
Що: Захист «не зупиняйся рано». Якщо наш поточний запас уперед ще хоча б близько 2 секунд, ми НЕ вважаємо це справжньою «мертвою» паузою.  
Збільшити (наприклад -1): Захист слабший — зупинимось раніше.  
Зменшити (наприклад -3): Терплячіше.  
Рекомендація: -3.0 … -1.0.

---

### 3.7. Повтор сегмента (Replay)  [майже лише smart]

#### event_replay_buffer_min_s (1.0)
Що: Якщо запас відео вперед менший цього — дозволяємо тимчасово повторити останній сегмент, щоб не завмер кадр.  
Збільшити: Повтор спрацює раніше.  
Зменшити: Пізніше.  
Рекомендація: 0.8–1.5.

#### event_segment_arrival_risk_threshold_s (0.0)
Що: Поріг «скоро може завмерти». 0 = автоматично половина довжини сегмента.  
Збільшити: Попередження пізніше.  
Зменшити (>0): Раніше.  
Рекомендація: 0 або 0.5–2.0.

#### replay_cooldown_limit (3)
Що: Скільки разів поспіль можна повторювати без нових реальних сегментів.  
Збільшити: Довше імітація руху.  
Зменшити: Швидше здаємось.  
Рекомендація: 2–4.

---

## 4. Швидкі підказки (що змінити, якщо)

| Хочу | Що робити |
|------|-----------|
| Максимально швидко бачити нове | Знизити step3_changed_ratio до ~0.9, u1/u2 до ~0.45 |
| Менше запитів | Підняти u1/u2 до ~0.6–0.65, збільшити changed_ratio до ~1.05 |
| Заспокоїти «смиканий» потік | Підвищити step3_cv_floor_ratio до ~0.45 |
| Швидше наздоганяти ефір | Підвищити drift_reduce1/2 (0.12 / 0.25), знизити drift_min_ratio до ~0.30 |
| Рідше хибні зупинки | gap_stop_min_absolute_s → 15; gap_drift_guard_trigger → -2.5 |
| М’якший повтор | replay_cooldown_limit → 2; event_replay_buffer_min_s → 1.2 |

(Якщо не впевнені — нічого не змінюйте.)

---

## 5. Часті питання

**Чи потрібно знати HLS, щоб це налаштовувати?**  
Ні. Просто розумійте ідею: ми періодично оновлюємо список сегментів.

**Можна все лишити як є?**  
Так. Це безпечний універсальний набір.

**Чому так багато налаштувань?**  
Щоб можна було балансувати між “швидко показати” і “не перевантажити сервер”.

**Якщо щось зламав?**  
Поверніть значення за замовчуванням (із цього файлу: «tvlink/libs/streamlink/stream/hls/hls.py»).

**Replay — це не «обман»?**  
Ні, ми просто повторюємо вже завантажений сегмент, щоб екран не завмер.

---

## 6. Міні-набори (готові комбінації)

Стабільний потік (хочу тихіше):
```
step3_u1_ratio = 0.55
step3_u2_ratio = 0.55
reload_early_offset_s = 0.0
```

Відстає / хочу наздогнати:
```
step3_drift_reduce1 = 0.12
step3_drift_reduce2 = 0.25
step3_drift_min_ratio = 0.30
```

Хибні «стопи» надто рано:
```
gap_stop_min_absolute_s = 15
gap_drift_guard_trigger = -2.5
```

---

## 7. Підсумок
1. Оберіть режим smart — отримаєте всі можливості.  
2. Не впевнені — залиште як є.  
3. Змінюйте лише розуміючи мету.  

Приємного перегляду!