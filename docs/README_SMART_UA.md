# Smart Live та Local VOD режими + Логіка Gap/Threshold (Керівництво користувача)

Цей документ описує два покращених режими керування відтворенням (Smart Live і Local VOD), а також логіку зупинки за розривами/порогами та дві функції роботи з’єднань. Викладено просто, без складних формул. Ви дізнаєтеся:
- Навіщо ці режими та їх переваги.
- Як приймаються адаптивні рішення щодо опитування та буферизації.
- Як читати журнали (логи) і розуміти поведінку.
- Коли й чому потік раніше завершується (захисні пороги).
- Що роблять параметри “Закрити з’єднання сегмента” та “Асинхронне закриття”.

---

## 1. Smart Live режим

### 1.1. Призначення та переваги
Звичайний HLS-опит (polling) використовує фіксовані або прості інтервали (наприклад targetduration). При нестабільній мережі чи нерівномірній появі сегментів це призводить до:
- Надмірних запитів (зайве навантаження).
- Недостатнього опитування (просідання буфера / фризи).
- Повільного відновлення після збоїв.

Smart Live (`hls-playlist-reload-time=smart`) коригує період перезавантаження плейлиста залежно від “буфера наперед” — скільки секунд відтворюваного контенту завантажено наперед відносно реального часу. Це:
- Прискорює опитування при низькому буфері (менше фризів).
- Сповільнює при достатньому буфері (менше навантаження).
- Використовує короткі “grace” затримки, щоб врахувати щойно завершені сегменти перед наступним плануванням.
- Раніше зупиняє потік при реальних зависаннях (від’ємний буфер, затягнуті завантаження), замість нескінченного очікування.

### 1.2. Основні ідеї (простими словами)
- “Буфер наперед” = скільки секунд вже повністю завантажено і ще не “програно” за стіною часу.
- “Цільова ємність” обчислюється зі середньої тривалості сегментів та множника (`hls-live-buffer-mult`) — умовна безпечна подушка.
- Режими:
  - GROWTH: буфер низький → частіше оновлюємо.
  - NORMAL: буфер у нормі → період ≈ довжина сегмента.
  - SLOW: буфер завеликий → збільшуємо паузу.
- Короткі “grace” паузи (до ~1с) вставляються, якщо сегменти майже завершуються.

Налаштовувати формули не потрібно — лише ключові параметри за потреби.

### 1.3. Важливі параметри (Live)
- `hls-playlist-reload-time=smart` — вмикає Smart Live.
- `hls-live-buffer-mult` — множник цільового буфера (≈3× середньої тривалості).
- `hls-segment-queue-threshold` — коефіцієнт порогу “тиші” (використовується ще й у smart-перевірці).
- `hls-live-edge` — стартова позиція відносно краю live.
- `hls-live-restart` — примусовий початок з початку, якщо можливо.

### 1.4. Захисні умови (Smart)
Потік може завершитися (це запобігання зависанню), якщо:
1. Завантаження сегмента перевищує його тривалість І буфер стає від’ємним.
2. Буфер входить у мінус кілька разів у межах ковзного вікна (типово: 3 рази за 60с).
3. Від’ємний дефіцит перевищує довжину останнього сегмента.
4. Буфер безперервно від’ємний довше порога (перерахованого з логіки gap).

### 1.5. Приклади логів (Smart Live)
- `- Adding segment N to queue` — сегмент додано в чергу.
- `+ Segment N complete (time=...ms retries=R)` — сегмент завантажено (R — часткові повтори).
- `<< Planning Reload [smart] in X.XXs ... mode=growth|normal|slow` — план наступного опитування.
- `>> Reloading Playlist [smart]: base=... planned=... | waited=...` — виконано перезавантаження.
- `LARGE JUMP: skipped ... segments` — стрибок нумерації; скидання статистики.
- `Negative buffer event #K` — буфер знову від’ємний.
- `Segment N exceeded its duration while downloading ... Stopping...` — захисне завершення.
- `Buffer deficit exceeded last segment length ... Stopping...`
- `Buffer stayed negative for more than Ts. Stopping...`

### 1.6. Часткові повтори (partial)
При обривах:
- `Partial/incomplete segment N ... retrying...`
Виконує до 2 додаткових спроб (із відновленням через Range, де можливо).

---

## 2. Local VOD режим

### 2.1. Призначення та переваги
Частина плейлистів — це ковзні вікна (catch-up / timeshift) або завершені списки сегментів. Local VOD вмикається при типі VOD або тегу `#EXT-X-ENDLIST` (чи впізнаній схемі). Він:
- Додає сегменти пакетами з поточного вікна.
- Адаптує інтервали між пакетами за швидкістю та заповненням буфера.
- Переходить до наступного вікна (формує новий URL) після завершення поточного.
- Не перезавантажує плейлист на кожен сегмент.

### 2.2. Схеми catch-up
Визначаються з початкового URL:
- “shift” (параметри `utc=` або `lutc=`),
- “append” (`offset=` або `utcstart=`),
- “flussonic” (`-timeshift_rel-` у шляху),
- Або звичайний VOD (без змін).
Після завершення сегментів будується новий URL (якщо можливо).

### 2.3. Параметри пакетів
- “VOD Limit segments on startup” (vod-start) — початковий “ривок” у першому вікні.
- “VOD Limit segments in progress” (vod-process) — початковий ривок у наступних вікнах.
- “VOD segments queue Step” (vod-queue-step) — кількість сегментів за один крок після ривка.
Забезпечує швидкий старт та рівномірне завантаження.

### 2.4. Адаптивна пауза (Local VOD)
Між пакетами система:
- Формує “стійку” середню (медіана + високий перцентиль).
- Веде згладжене заповнення буфера.
- Відстежує EMA співвідношення “час завантаження / тривалість”.
- Увімкне “steady mode” при серії повільних сегментів.
- М’яко гальмує при надлишковому буфері.

### 2.5. Захист (Local VOD)
Окрім smart-правил:
- Порожні вікна: кілька поспіль порожніх — зупинка.
- Скидання нумерації: якщо нове вікно почалось з “початку”, переходить на його початок.

### 2.6. Приклади логів (Local VOD)
- `<< Local VOD: next enqueue adaptive in X.XXs (seg=... buf=.../cap=...)`
- `VOD local: advancing window url -> ...`
- `VOD local: numbering reset/no forward segments...`
- `VOD local: empty window after advance, closing stream.`
- Аналогічні попередження про буфер і сегменти, як у Smart.

---

## 3. Gap Threshold та рання зупинка

### 3.1. Призначення
У не-smart режимах (segment/targetduration/default) чекати вічно без нових сегментів не має сенсу. Gap поріг — максимальний час “тиші”. Перевищено → завершення. У smart ця величина використовується як одна з перевірок від’ємного буфера.

### 3.2. Розрахунок (спрощено)
Якщо `hls-segment-queue-threshold` > 0:
1. База = максимум із:
   - Мінімум 5с,
   - targetduration (якщо є),
   - Середнє останніх до 3 сегментів (або тривалість останнього).
2. Множимо на коефіцієнт → поріг.
3. Нема нових сегментів довше — попередження і зупинка.

### 3.3. Відмінності Smart
Smart не покладається на це для звичайного планування, але:
- Використовує ту ж величину як частину “третьої” умови: безперервно від’ємний буфер довше порога → зупинка.
- Інші smart-умови можуть спрацювати раніше.

### 3.4. Логи (Gap)
- `=> No new segments in playlist for more than X.XXs. Stopping...`

---

## 4. З’єднання та закриття

### 4.1. Close segment connection (hls-segment-conn-close)
Призначення:
- Додає `Connection: close` до HTTP-запитів сегментів/ключів/плейлистів.
Корисно при проблемах з keep-alive (зависання).

Плюси:
- Менше “прилиплих” з’єднань.
Мінуси:
- Додаткові витрати на встановлення з’єднання.
Увімкніть при частих зависаннях.

### 4.2. `hls-close-async`
Призначення:
- Прискорює завершення потоку без блокування основного процесу.
Поведение:
- Закриття йде у фоновому потоці.
- “Fast abort”: скасування незавершених завантажень, очищення кешів, звільнення пам’яті.
- Фільтр логів для придушення шуму.

Корисно при багатьох потоках або коли важлива швидка реакція перемикання каналів. За замовчуванням увімкнено.

---

## 5. Довідник логів

| Фрагмент | Значення |
|----------|----------|
| `<< Planning Reload [smart]... mode=growth` | Низький буфер; прискорення опитування. |
| `<< Planning Reload [smart]... mode=slow` | Високий буфер; сповільнення. |
| `+ Segment N complete (time=... retries=R)` | Сегмент завантажено; R — кількість повторів. |
| `Partial/incomplete segment N ... retrying...` | Тимчасовий мережевий збій; повтор. |
| `Segment N exceeded its duration ...` | Застрягання; захисна зупинка. |
| `Negative buffer event #K` | Буфер знову від’ємний. |
| `Buffer deficit exceeded last segment length ...` | Критичний дефіцит; зупинка. |
| `=> No new segments ... Stopping...` | Перевищено поріг тиші. |
| `Local VOD: next enqueue adaptive in X.XXs` | Адаптивна пауза між пакетами. |
| `LARGE JUMP: skipped ... segments` | Стрибок нумерації. |
| `Filtering out segments and pausing stream output` | Фільтрація сегментів, пауза виводу. |
| `Retry fetch failed for segment N` | Остання спроба не вдалася. |
| `VOD local: advancing window url -> ...` | Перехід до нового вікна. |
| `VOD local: empty window after advance...` | Нове вікно порожнє — завершення. |

---

## 6. Практичні поради

- Часті завершення у smart → перевірте джерело; спробуйте `targetduration` для діагностики.
- Багато partial/retry → нестабільна мережа; спробуйте `hls-segment-conn-close`.
- Висока затримка мережі → збільшіть `live-buffer-mult`.
- Потрібна мінімальна затримка → зменшіть `live-buffer-mult` (ризик фризів).
- Local VOD: корегуйте `vod-start`, `vod-process`, `vod-queue-step` для балансу старту / рівномірності.

---

## 7. Підсумок

Smart Live та Local VOD роблять споживання HLS стійкішим: менше фризів, оптимізовані запити, прозорі рішення. Пороги розривів та захисні правила запобігають нескінченному очікуванню. Параметри з’єднань і асинхронне закриття додають контроль і швидкість. Журнали — ваш діагностичний інструмент: майже кожен адаптивний крок задокументовано.

Бажаємо стабільної роботи і прогнозованих стримів!